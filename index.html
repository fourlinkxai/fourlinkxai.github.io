<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Fourlinkx Photo Ai</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #141e30, #243b55);
    color: #e3eafc;
    max-width: 350px;
    height: 600px;
    margin: 0 auto;
    padding: 20px 15px;
    display: flex;
    flex-direction: column;
    user-select: none;
    overflow: hidden;
  }
  h1 {
    margin: 0 0 10px 0;
    font-weight: 600;
    font-size: 2rem;
    text-align: center;
    color: #63b3ed;
    text-shadow: 0 0 6px #2c7be5cc;
  }
  p.description {
    margin: 0 0 20px 0;
    font-weight: 300;
    font-size: 1rem;
    text-align: center;
    color: #9bb7e6dd;
  }
  label.upload-label {
    border: 2px dashed #58a6ffcc;
    border-radius: 16px;
    padding: 30px 12px;
    text-align: center;
    color: #65a3ffcc;
    cursor: pointer;
    transition: border-color 0.3s, color 0.3s, background-color 0.15s;
    user-select: none;
    font-weight: 600;
    font-size: 1.1rem;
  }
  label.upload-label:hover,
  label.upload-label:focus-visible {
    border-color: #8dbdff;
    color: #8dbdff;
    background-color: rgba(55, 95, 188, 0.3);
    outline: none;
  }
  input#file-input {
    display: none;
  }
  .preview-container {
    margin-top: 20px;
    display: flex;
    gap: 12px;
    justify-content: center;
    overflow-x: auto;
    padding-bottom: 12px;
  }
  figure {
    margin: 0;
    width: 48%;
    background-color: rgba(30, 50, 100, 0.7);
    border-radius: 16px;
    padding: 12px;
    box-shadow: 0 3px 10px rgba(30, 95, 255, 0.5);
  }
  figure img,
  figure canvas {
    max-width: 100%;
    border-radius: 12px;
    box-shadow: 0 0 14px rgba(40, 110, 255, 0.6);
    display: block;
    margin: 0 auto;
  }
  figcaption {
    margin-top: 10px;
    color: #7ea9ffcc;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
    user-select: none;
  }
  button#generate-btn {
    margin-top: auto;
    font-weight: 700;
    font-size: 1.2rem;
    padding: 14px 0;
    border-radius: 16px;
    border: none;
    background-color: #3e7ff8;
    color: #d6e2ff;
    cursor: pointer;
    box-shadow: 0 7px 20px rgba(63, 123, 245, 0.6);
    transition: background-color 0.25s;
    user-select: none;
  }
  button#generate-btn:disabled {
    background-color: #2a4d8c88;
    cursor: not-allowed;
    box-shadow: none;
    color: #94a9ccaa;
  }
  button#generate-btn:hover:not(:disabled) {
    background-color: #2d6bdb;
    box-shadow: 0 9px 25px rgba(47, 105, 230, 0.9);
  }
  p#instruction {
    margin-top: 15px;
    font-weight: 300;
    font-size: 0.85rem;
    color: #aac3ffbb;
    text-align: center;
    user-select: none;
  }
  .preview-container::-webkit-scrollbar {
    height: 6px;
  }
  .preview-container::-webkit-scrollbar-thumb {
    background-color: #7ea9ffbb;
    border-radius: 4px;
  }
  @media (max-width: 350px) {
    h1 {
      font-size: 1.7rem;
    }
    button#generate-btn {
      font-size: 1.1rem;
      padding: 12px 0;
    }
    figure {
      width: 49%;
    }
  }
</style>
</head>
<body>
  <h1>Fourlinkx Photo Ai</h1>
  <p class="description">Upload a photo and watch your AI-stylized cartoon transformation!</p>

  <label class="upload-label" for="file-input" tabindex="0" aria-label="Upload your photo or image">
    Click or tap here to upload photo
    <input type="file" id="file-input" accept="image/*" />
  </label>

  <div class="preview-container" aria-live="polite" aria-relevant="additions removals" aria-atomic="true">
    <figure id="original-figure" hidden>
      <img id="original-img" alt="Original uploaded photo preview" />
      <figcaption>Original Photo</figcaption>
    </figure>
    <figure id="ai-figure" hidden>
      <canvas id="ai-canvas" aria-label="AI generated image"></canvas>
      <figcaption>AI-Generated Cartoon Image</figcaption>
    </figure>
  </div>

  <button id="generate-btn" disabled aria-disabled="true" type="button">Generate AI Cartoon</button>

  <p id="instruction">All processing happens in your browser; your images are private and never uploaded.</p>

<script>
  (() => {
    const fileInput = document.getElementById('file-input');
    const generateBtn = document.getElementById('generate-btn');
    const originalFigure = document.getElementById('original-figure');
    const originalImg = document.getElementById('original-img');
    const aiFigure = document.getElementById('ai-figure');
    const aiCanvas = document.getElementById('ai-canvas');
    const aiCtx = aiCanvas.getContext('2d');

    let loadedImage = null;

    function reset() {
      originalFigure.hidden = true;
      aiFigure.hidden = true;
      generateBtn.disabled = true;
      generateBtn.setAttribute('aria-disabled', 'true');
      aiCanvas.width = 0;
      aiCanvas.height = 0;
      originalImg.src = "";
      loadedImage = null;
    }

    function loadImage(file) {
      reset();
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        URL.revokeObjectURL(url);
        loadedImage = img;
        originalImg.src = img.src;
        originalFigure.hidden = false;
        generateBtn.disabled = false;
        generateBtn.setAttribute('aria-disabled', 'false');
      };
      img.onerror = () => {
        alert("Failed to load image. Please try a different one.");
        reset();
      }
      img.src = url;
    }

    function cartoonifyImage() {
      if (!loadedImage) return;

      const maxWidth = 340;
      const scale = Math.min(1, maxWidth / loadedImage.width);
      const canvasWidth = Math.floor(loadedImage.width * scale);
      const canvasHeight = Math.floor(loadedImage.height * scale);

      // Draw scaled down image to offscreen canvas
      const offcanvas = document.createElement('canvas');
      offcanvas.width = canvasWidth;
      offcanvas.height = canvasHeight;
      const offCtx = offcanvas.getContext('2d');
      offCtx.drawImage(loadedImage, 0, 0, canvasWidth, canvasHeight);

      // Get the image data from the offscreen canvas
      const imgData = offCtx.getImageData(0, 0, canvasWidth, canvasHeight);
      const data = imgData.data;

      // Apply color quantization (posterize to reduce colors)
      const levels = 6;
      for(let i = 0; i < data.length; i += 4) {
        data[i] = Math.floor(data[i] / 255 * levels) / levels * 255;      // R
        data[i + 1] = Math.floor(data[i + 1] / 255 * levels) / levels * 255;  // G
        data[i + 2] = Math.floor(data[i + 2] / 255 * levels) / levels * 255;  // B
        // Alpha stays unchanged
      }

      offCtx.putImageData(imgData, 0, 0);

      // Strong edge detection for outlines

      // Sobel kernels for edge detection
      const sobelX = [
        -1, 0, 1,
        -2, 0, 2,
        -1, 0, 1
      ];
      const sobelY = [
        -1, -2, -1,
         0,  0,  0,
         1,  2,  1
      ];

      function getPixelIntensity(x, y) {
        if(x < 0 || y < 0 || x >= canvasWidth || y >= canvasHeight) return 0;
        const idx = (y * canvasWidth + x) * 4;
        return 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
      }

      const edgeData = new Uint8ClampedArray(canvasWidth * canvasHeight);

      for(let y = 0; y < canvasHeight; y++) {
        for(let x = 0; x < canvasWidth; x++) {
          let gx = 0;
          let gy = 0;
          // Convolution 3x3
          for(let ky = -1; ky <= 1; ky++) {
            for(let kx = -1; kx <= 1; kx++) {
              const val = getPixelIntensity(x + kx, y + ky);
              const kernelIdx = (ky + 1) * 3 + (kx + 1);
              gx += val * sobelX[kernelIdx];
              gy += val * sobelY[kernelIdx];
            }
          }
          const g = Math.sqrt(gx * gx + gy * gy);
          edgeData[y * canvasWidth + x] = g > 100 ? 0 : 255; // Threshold and invert for lines
        }
      }

      // Draw cartoon image to main canvas
      aiCanvas.width = canvasWidth;
      aiCanvas.height = canvasHeight;
      aiCtx.clearRect(0, 0, canvasWidth, canvasHeight);
      aiCtx.drawImage(offcanvas, 0, 0);

      // Draw edges as black lines on top
      const edgeImgData = aiCtx.getImageData(0, 0, canvasWidth, canvasHeight);
      const edgePixels = edgeImgData.data;

      for(let i = 0; i < edgeData.length; i++) {
        if(edgeData[i] === 0) {
          edgePixels[i * 4] = 0;
          edgePixels[i * 4 + 1] = 0;
          edgePixels[i * 4 + 2] = 0;
          edgePixels[i * 4 + 3] = 255;
        }
      }
      aiCtx.putImageData(edgeImgData, 0, 0);

      aiFigure.hidden = false;
    }

    fileInput.addEventListener('change', e => {
      if (e.target.files.length > 0) {
        loadImage(e.target.files[0]);
      }
    });

    generateBtn.addEventListener('click', () => {
      cartoonifyImage();
      generateBtn.blur();
    });

    // Accessibility: keyboard trigger upload dialog on label focus + enter/space
    const uploadLabel = document.querySelector('label.upload-label');
    uploadLabel.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });

    reset();

  })();
</script>
</body>
</html>
